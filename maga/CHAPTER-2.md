
# Глава 2. Основные принципы доверенной среды исполнения и модель угроз

 ## 2.1. Обзор доверенной среды исполнения

  ### 2.1.1. Определение и основные принципы

   #### 2.1.1.1. Доверенная среда исполнения

   Доверенная среда исполнения (ДСИ), или же
   Trusted Execution Environment (TEE) - это безопасная,
   изолированная область внутри центрального процессора.
   Она предназначена для выполнения кода
   и обработки данных с повышенным уровнем конфиденциальности
   и целостности по сравнению со стандартной операционной средой,
   называемой универсальной средой исполнения (УСИ), или же
   Rich Execution Environment (REE).

   В рамках ДСИ работает специализированная
   безопасная операционная система, называемая
   доверенной операционной системой (Secure OS),
   которая работает параллельно обыкновенной операционной
   системе в УСИ, называемой
   универсальной операционной системой (Rich OS).

   ДСИ гарантирует защиту таких активов,
   как конфиденциальные данные и критически важный код,
   которые хранятся и обрабатываются в её пределах
   и остаются недоступными,
   даже в случае компроментации REE операционной системы
   или приложений УСИ.

   Защита реализуется посредством сочетания
   аппаратных и программных механизмов,
   которые обеспечивают строгую изоляцию между ДСИ и УСИ.
   Функционирование и гарантии безопасности ДСИ базируются
   на ряде ключевых принципов,
   детально рассмотренных далее.

   #### 2.1.1.2 Изоляция

   Изоляция в контексте доверенной среды исполнения
   представляет собой фундаментальный принцип разделения
   вычислительной среды на две физически разграниченные области:
   нормальный мир (Normal World), и защищённый мир (Secure World).
   Такое разделение гарантирует,
   что операции и данные в защищённом мире защищены
   от вмешательства или несанкционированного доступа
   со стороны программного обеспечения,
   работающего в обычном мире,
   включая основную операционную систему и её приложения.
   Для поддержания этого разделения обычно используются
   аппаратные механизмы изоляции,
   которые предотвращают прямой доступ кода
   из одного мира к ресурсам или памяти,
   выделенным другому миру,
   за исключением случаев,
   когда это явно разрешено через строго контролируемые интерфейсы.

   #### 2.1.1.3 Целостность

   Целостность в TEE гарантирует,
   что код и данные, находящиеся
   и обрабатываемые в защищённом мире,
   остаются неизменными
   и сохраняют своё первоначальное состояние.
   Это означает, что ни внешние субъекты из обычного мира,
   ни неавторизованные процессы внутри защищённого мира
   не могут модифицировать критически важный код,
   такой как операционная система TEE
   или доверенные приложения,
   а также управляемые ими чувствительные данные.
   Целостность обычно обеспечивается такими механизмами,
   как безопасная загрузка (secure boot),
   подписанный и зашифрованый код,
   защита памяти во время исполнения
   и использование криптографических контрольных сумм.
   Это гарантирует выполнение только проверенных
   и аутентичных программных компонентов
   и защиту данных от злонамеренных изменений.

   #### 2.1.1.4 Конфиденциальность

   Конфиденциальность - это принцип TEE,
   обеспечивающий защиту данных и кода в защищённом мире
   от несанкционированного раскрытия.
   Это означает, что никакой программный компонент,
   работающий за пределами TEE,
   включая потенциально скомпрометированную
   операционную систему обычного мира
   или привилегированные приложения,
   не может считывать или получать доступ
   к приватным областям памяти TEE.
   Конфиденциальность распространяется
   как на данные в процессе обработки
   (например, обрабатываемые криптографические ключи),
   так и на хранимые данные.

   #### 2.1.1.5 Защищённое хранилище

   Защищённое хранилище (Secure Storage) -
   это функциональная возможность TEE,
   предоставляющая механизм для
   постоянного хранения чувствительных данных,
   таких как криптографические ключи,
   учетные данные пользователей
   или другая конфиденциальная информация,
   способом, который защищает их конфиденциальность
   и целостность даже при
   выключенном питании системы.
   Данные, сохраняемые с использованием этого механизма,
   шифруются и защищаются с использованием ключей,
   управляемых внутри TEE.
   Доступ к этим сохраненным данным
   строго контролируется TEE, гарантируя,
   что только авторизованные доверенные приложения
   могут извлекать или изменять
   принадлежащую им чувствительную информацию.

   #### 2.1.1.6 Аттестация

   Аттестация позволяет TEE
   доказать свою подлинность
   и целостность исполняемой в ней
   программной среды удалённой стороне.
   Этот процесс обычно включает генерацию
   TEE подписанного отчёта,
   содержащего измерения её аппаратной конфигурации,
   микропрограмм, ОС и загруженных доверенных приложений.
   Удалённая сторона может проверить этот отчёт
   с использованием доверенного ключа,
   тем самым получая уверенность в том,
   что она взаимодействует с подлинной TEE
   и что конфигурация программного обеспечения
   соответствует ожиданиям и не была скомпрометирована.

   #### 2.1.1.7 Доверенное исполнение

   Доверенное исполнение (Trusted Execution)
   гарантирует, что только авторизованный
   и проверенный код допускается к запуску в пределах TEE.
   Это включает механизмы аутентификации кода
   (например, с помощью цифровых подписей)
   перед его загрузкой и выполнением в защищённом мире.
   Ограничивая исполнение только известными и
   проверенными программными компонентами,
   TEE поддерживает контролируемую и безопасную среду,
   предотвращая выполнение вредоносного или
   недоверенного кода.

   #### 2.1.1.8 Минимальная доверенная вычислительная база

   Принцип минимальной доверенной вычислительной базы
   (Minimal Trusted Computing Base, TCB)
   заключается в том,
   что совокупность всех аппаратных,
   микропрограммных и программных компонентов,
   критически важных для обеспечения политики безопасности системы,
   должна быть как можно меньше.
   Минимизация TCB сокращает поверхность атаки,
   упрощает анализ и верификацию безопасности,
   а также снижает вероятность наличия уязвимостей,
   способных скомпрометировать всю TEE.
   В TCB обычно входят защищённые аппаратные элементы,
   доверенные загрузчики, ядро Secure OS и
   набор основных доверенных сервисов.
   Основой доверия к самой TCB служит
   аппаратный корень доверия (RoT).

  ### 2.1.2. Требования к безопасности и цели проектирования

   #### 2.1.2.1. Ключевые компоненты

   В основе архитектуры доверенной среды исполнения
   лежит набор фундаментальных компонентов.
   Каждый из них вносит свой вклад
   в обеспечение общей безопасности системы.
   Эти компоненты, подробно рассмотренные далее,
   совместно создают и поддерживают доверенную среду,
   определяя ее структуру, операционные границы
   и протоколы взаимодействия.

   #### 2.1.2.2. Изолированный исполнительный блок

   Одним из фундаментальных требований
   является наличие физически изолированного
   исполнительного блока,
   обеспечивающего аппаратное разделение
   для выполнения защищенного кода.
   В рамках данного проекта эта роль отводится
   выделенному ядру центрального процессора,
   эксклюзивно назначенному для Secure OS.
   Данный блок гарантирует,
   что операции внутри TEE
   защищены от прямого наблюдения или вмешательства
   со стороны недоверенного программного обеспечения,
   работающего на других ядрах
   или в менее привилегированных режимах выполнения.

   #### 2.1.2.3. Нормальный мир

   Нормальный мир (Normal World)
   представляет собой недоверенный домен исполнения,
   являющийся универсальной средой исполнения
   (Rich Execution Environment),
   в которой функционирует операционная система
   общего назначения, такая как Linux, и ее приложения.
   Все программное обеспечение в нормальном мире
   рассматривается TEE как потенциально враждебное
   и аппаратно лишено возможности
   прямого доступа к ресурсам защищенного мира.

   #### 2.1.2.4. Защищенный мир

   В свою очередь, защищенный мир (Secure World) - это
   доверенный домен, являющийся доверенной средой исполнения
   (Trusted Execution Environment),
   в которой функционирует Secure OS и доверенные приложения.
   Он спроектирован таким образом,
   чтобы противостоять угрозам,
   исходящим из нормального мира,
   гарантируя конфиденциальность и целостность
   управляемых им активов и выполняемых вычислений.

   #### 2.1.2.5. Доверенные приложения

   Доверенные приложения (TA) - это
   специализированные программные модули,
   исполняемые в защищенном мире
   для выполнения критически важных
   с точки зрения безопасности операций
   по запросу клиентов из нормального мира.
   TA предоставляют такие функции,
   как безопасная обработка данных,
   криптографические операции
   или управление чувствительными данными,
   доступ к которым осуществляется
   через четко определенные и контролируемые интерфейсы.

   #### 2.1.2.6. Защищенные API

   Защищенные API (Secure APIs) определяют контролируемые интерфейсы,
   через которые программное обеспечение нормального мира
   может запрашивать службы у защищенного мира,
   в частности, у доверенных приложений.
   Эти API, такие как подмножество
   GlobalPlatform TEE Client API и
   GlobalPlatform TEE Core API,
   функционируют как строго контролируемые шлюзы.
   Они отвечают за преобразование данных и гарантируют,
   что все взаимодействия четко определены,
   проверены и авторизованы в соответствии
   с политиками безопасности TEE перед
   выполнением службы в pащищенном мире.

 ## 2.2 Модель угроз

  ### 2.2.1 Допущения относительно нормального мира

   #### 2.2.1.1. Недоверенная ОС

   Операционная система нормального мира
   (например, Linux) и все исполняемые в ней приложения
   принципиально рассматриваются как недоверенные
   с точки зрения безопасного мира.
   Это допущение исходит из того,
   что нормальный мир,
   обладая большей кодовой базой
   и обширной поверхностью атаки,
   подвержен компрометации
   различными вредоносными программами,
   включая руткиты пользовательского и ядерного уровней.

   Следовательно, никакие конфиденциальные данные,
   такие как криптографические ключи
   или приватная информация,
   обрабатываемая доверенными приложениями,
   не могут храниться или обрабатываться
   непосредственно в нормальном мире без надежной защиты,
   управляемой со стороны ДСИ.
   Нельзя предполагать, что код,
   исполняемый в нормальном мире,
   сохранит свою целостность.

   #### 2.2.1.2. Враждебная ОС

   Более того, предполагается,
   что ОС Обычного мира может быть не просто недоверенной,
   а враждебной, то есть может активно пытаться
   подорвать безопасность и целостность ДСИ.
   Она может использовать свой привилегированный доступ
   к физическим ресурсам
   для попыток несанкционированного доступа,
   например, пытаясь прочитать
   или изменить области памяти,
   выделенные безопасному миру,
   несмотря на аппаратные средства защиты.

   ОС Обычного мира может пытаться перехватывать,
   анализировать, модифицировать или повторять сообщения,
   передаваемые через интерфейсы разделяемой памяти
   между нормальным и безопасным мирами.

   Атаки на доступность сервисов ДСИ,
   такие как DoS-атаки,
   могут быть инициированы из
   нормального мира путем
   переполнения каналов связи ложными запросами
   или манипулирования ресурсами нормального мира,
   критически важными для работы ДСИ.

   #### 2.2.1.3. Ограниченная видимость

   Критически важным допущением,
   обеспечиваемым аппаратными механизмами,
   такими как расширение RISC-V World Guard,
   является отсутствие у ОС нормального мира прямого доступа
   видимости приватных областей памяти Secure OS
   и ее доверенных приложений.
   Даже обладая привилегиями уровня ядра в нормальном мире,
   Rich OS должна быть аппаратно лишена возможности
   прямого чтения, записи или исполнения кода
   в защищенной памяти безопасного мира.
   Это является основой для гарантий
   конфиденциальности и целостности ДСИ.

   #### 2.2.1.4. Контроль над незащищенными ресурсами

   Нормальный мир сохраняет контроль над всеми системными ресурсами,
   не обозначенными явно как безопасные или управляемые Secure OS.
   Сюда входит большинство периферийных устройств
   (например, сетевые интерфейсы,
   устройства хранения общего назначения,
   пользовательские интерфейсы)
   и общесистемные функции управления ресурсами.

   Таким образом, ОС Обычного мира отвечает
   за мультиплексирование доступа к
   разделяемым периферийным устройствам
   и выступает посредником для внешних коммуникаций,
   необходимых доверенным приложениям,
   перенаправляя запросы от внешних источников
   или приложений нормального мира в ДСИ
   и передавая результаты обратно.

   Таким образом Rich OS является ответственной за контроль
   всех недоверенных приложений и устройств,
   и значит ДСИ не должна иметь доступ в
   универсальную среду исполнения, так же как и
   УСИ не имеет доступа к ДСИ.

   #### 2.2.1.5. Приоритеты планирования и управление

   Операционная система нормального мира обладает
   всеми полномочиями по планированию выполнения
   приложений и задач на выделенных ей ядрах процессора.
   Приоритет выполнения процессов Обычного мира,
   включая те, которые инициируют взаимодействие с ДСИ,
   определяются политиками ОС Обычного мира.

   В свою очередь, Secure OS функционирует
   с исполнительной автономией на своем выделенном ядре.
   Secure OS непосредственно управляет собственными
   потоками выполнения и планированием внутренних задач
   и доверенных приложений,
   независимо от решений планирования ОС нормального мира.

  ### 2.2.2. Векторы атак

   #### 2.2.2.1. Атаки с использованием прямого доступа к памяти

   Незащщенные контроллеры прямого доступа к памяти (DMA),
   особенно те, что управляются периферийными устройствами
   из нормального мира,
   представляют собой серьезную угрозу.
   Если они не изолированы должным образом,
   вредоносное программное обеспечение
   нормального мира может запрограммировать их
   на произвольное чтение или запись
   в память безопасного мира,
   обходя механизмы изоляции,
   обеспечиваемые центральным процессором.

   Например, скомпрометированный драйвер
   в нормальном мире может дать команду
   связанному с ним DMA-контроллеру
   периферийного устройства
   нацелиться на области памяти,
   выделенные для Secure OS или TA,
   что приведет к нарушению конфиденциальности
   и целостности данных.

   Применение модуля управления памятью ввода-вывода (IOMMU) крайне важно.
   IOMMU способен обеспечивать защиту памяти
   путем трансляции адресов устройств в физические адреса
   и проверки разрешений, гарантируя,
   что периферийные устройства могут обращаться
   только к авторизованным областям памяти.
   Правильная конфигурация IOMMU,
   обычно управляемая доверенным компонентом,
   таким как Secure OS или SEE,
   критически важна для предотвращения таких атак.

   #### 2.2.2.2 Атаки по сторонним каналам

   Атаки данного эксплуатируют косвенную утечку информации,
   связанную с физической реализацией системы,
   а не с прямыми уязвимостями программного обеспечения.
   Информацию можно получить путем наблюдения
   за временем выполнения,
   характером энергопотребления,
   электромагнитным излучением
   или шаблонами доступа к кэш-памяти.

   Примерами служат атаки типа Meltdown, Spectre и Red Bleeding,
   которые эксплуатируют особенности микроархитектуры
   (например, спекулятивное выполнение, кэширование данных).

   Для противодействия следует использовать
   алгоритмы с постоянным временем выполнения в TEE,
   аппаратуру, устойчивую к атакам по сторонним каналам,
   методы внесения шума, а также применять
   секционирование кэша или техники его очистки.

   #### 2.2.2.3. Физические атаки

   Физические атаки подразумевают прямое взаимодействие
   с аппаратным обеспечением для компрометации TEE.
   Это включает методы внедрения сбоев,
   такие как генерация глитчей тактового сигнала или питания,
   изменение напряжения или использование
   сфокусированного электромагнитного излучения
   с целью вызвать сбои в работе процессора или памяти.

   Физический доступ в сочетании
   с привилегиями обычного мира
   может помочь в организации атак,
   таких как зондирование внутренних шин
   или внедрение вредоносных сигналов.

   #### 2.2.2.4. Эксплуатирование API

   Вредоносное программное обеспечение
   из нормального мира может генерировать
   специальные входные данные
   или последовательности вызовов к API TEE,
   что может вызвать переполнение буфера,
   логические ошибки или повышение привилегий
   внутри безопасного мира.
   Для защиты от такого рода атак необходима
   строгая проверка входных данных
   и продуманный дизайн безопасной ОС.

   #### 2.2.2.5. Атаки типа MITM

   Канал связи между обычным
   и безопасным мирами является важным интерфейсом.
   Нормальный мир может манипулировать сообщениями,
   повторять их или отбрасывать,
   чтобы нарушить работу сервисов TEE
   или эксплуатировать их уязвимости.

   #### 2.2.2.6. Атаки типа DoS

   Затопление безопасного мира вызовами, истощение его ресурсов или блокирование каналов связи.
   Необходимы механизмы ограничения частоты запросов, сторожевые таймеры (watchdog timers) и возможность корректной деградации производительности.

   #### 2.2.2.7. Атаки на процесс загрузки и прошивку

   Компрометация загрузчика
   или процесса обновления прошивки
   может подорвать доверие к безопасному миру
   (например, путем загрузки вредоносной ОС
   или модификации доверенных приложений).
   Для защиты от такого рода атак необходима
   безопасная загрузка (secure boot)
   и криптографическая проверка
   образов прошивки и TA.