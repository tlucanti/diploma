
# Глава 3: Проектирование и реализация доверенной операционной системы

 ## 3.1. Соображения по выбору интерфейса

  ### 3.1.1. Базовое API ДСИ: Интерфейс взаимодействия между мирами

   #### 3.1.1.1. Введение в TEE API

   Базовое API TEE (Trusted Execution Environment Internal Core API)
   определяет функции, которые клиенты нормального мира
   используют для взаимодействия с доверенными приложениями,
   работающими в Secure OS.
   Этот интерфейс должен предоставлять
   механизмы для установки соединения,
   обмена данными, вызова защищённых функций
   и управления жизненным циклом безопасных сессий.

   Рассмотрим варианты, на которые можно обратить
   внимание при выборе интерфейса
   для доверенной операционной системы.

   #### 3.1.1.2. OP-TEE для RISC-V

   OP-TEE (Open Portable TEE) -
   это известная среда доверенного исполнения
   с открытым исходным кодом,
   изначально разработанная для технологии Arm TrustZone.
   OP-TEE реализует значительную часть спецификаций
   GlobalPlatform TEE, предоставляя богатый набор функций,
   включая внутренний API ядра TEE
   (TEE Internal Core API) для разработки TA
   и полнофункциональный клиентский API TEE.

   Хотя OP-TEE представляет собой зрелое
   и широко распространённое решение TEE,
   его архитектура сопряжена с определёнными особенностями.
   OP-TEE сама по себе является
   небольшой безопасной операционной системой,
   обычно работающей параллельно
   с Rich OS. Для данного проекта, прямое использование
   API OP-TEE потребовало бы либо значительных усилий
   по портированию и адаптации,
   либо диктовало бы архитектурные решения,
   менее соответствующие целям проекта по созданию минимальной,
   глубоко проработанной доверенной кодовой базы (TCB),
   адаптированной под World Guard.

   #### 3.1.1.3. Разработка собственного минимального интерфейса на базе GlobalPlatform TEE

   Альтернативным подходом рассматривалась
   разработка собственного,
   минимально необходимого интерфейса TEE,
   основанного на спецификациях
   GlobalPlatform TEE Internal Core API.
   Этот путь предполагает реализацию
   только ключевых функций API,
   необходимых для базового взаимодействия с TA:
   управление контекстами, сессиями, разделяемой памятью и вызовом команд.

   Разработка собственного минимального
   интерфейса имела несколько преимуществ:

  - Снижение сложности: <br>
    Меньший набор функций API
    упрощает реализацию Secure OS,
    что потенциально ведёт к уменьшению
    доверенной кодовой базы (TCB)
    и поверхности атак.

  - Адаптация под World Guard: <br>
    Интерфейс мог бы быть специально спроектирован
    для эффективного использования двухмировой модели
    расширения World Guard и его примитивов
    межмирового взаимодействия.
    Например, парадигма обмена данными
    через разделяемую память,
    предусмотренная проектом,
    может быть напрямую отражена в дизайне API.

  - Согласованность с архитектурой Безопасной ОС: <br>
    Интерфейс мог бы быть оптимально интегрирован
    с микроядерной архитектурой Secure OS
    и её handle-based моделью безопасности.

  - Контролируемый объём работ: <br>
    такой подход позволяет сфокусировать усилия
    на реализации ключевых функций TEE
    и их взаимодействии с World Guard.

   Основной проблемой этого подхода является
   обеспечение соответствия стандартам,
   даже для подмножества функций,
   и предоставление достаточной функциональности
   для создания значимых TA.

   #### 3.1.1.4. Экспериментальные и исследовательские прототипы

   В академическом и исследовательском сообществе
   существуют различные архитектуры TEE
   и механизмы межмирового взаимодействия,
   часто фокусируясь на новых аппаратных возможностях
   или специфических свойствах безопасности.
   Некоторые прототипы исследуют собственные механизмы RPC,
   отличающиеся модели разделения памяти
   или совершенно новые парадигмы API,
   отличные от GlobalPlatform.

   Хотя такие исследовательские прототипы
   предлагают ценные идеи для потенциальных улучшений TEE
   и специализированных решений безопасности,
   им часто не хватает стандартизации
   и широкой поддержки со стороны экосистемы,
   что критично для разработки переносимых TA.

   Внедрение полностью экспериментального API
   отклонилось бы от признанных в индустрии стандартов,
   повысило бы порог вхождения для потенциальных разработчиков
   и ограничило бы совместимость.

   #### 3.1.1.5. Обоснование выбора подмножества API на базе GlobalPlatform

   После оценки альтернатив было принято решение
   использовать тщательно подобранное подмножество
   GlobalPlatform TEE Internal Core API
   для межмирового взаимодействия.
   Этот подход призван сбалансировать стремление
   к стандартизации со специфическими требованиями
   и ограничениями проекта.

   Выбор стоится на следущих причинах:

  - Стандартизация и привычность: <br>
    Спецификации GlobalPlatform TEE Internal Core API
    предоставляют хорошо определённый,
    признанный в индустрии стандарт
    для взаимодействия между клиентом TEE и TA.
    Использование подмножества этого стандарта
    позволяет опереться на существующую базу знаний,
    облегчая разработчикам TA,
    знакомым с концепциями TEE,
    понимание и использование системы.

  - Ключевая функциональность: <br>
    GP TEE API определяет такие основополагающие концепции,
    как контексты, сессии, разделяемая память и вызов команд,
    которые являются фундаментальными
    для большинства взаимодействий с TEE.
    Реализация подмножества, содержащего эти ключевые элементы,
    обеспечивает достаточную функциональность
    для широкого круга Доверенных Приложений.

  - Уменьшение трудоёмкости реализации и ДКБ: <br>
    Выбирая только необходимые вызовы API,
    значительно снижается сложность реализации
    в Secure OS по сравнению с полной имплементацией GP.
    Это способствует уменьшению TCB,
    что критично для безопасности.

  - Возможность будущего расширения: <br>
    Начиная с минимального подмножества,
    фреймворк GP предлагает чёткий путь
    для потенциальных будущих расширений,
    если потребуется больше функций.
    Модульная природа спецификаций GP
    позволяет добавлять функциональность постепенно.

   Выбранное подмножество включает функции:
    - TEEC_InitializeContext
    - TEEC_FinalizeContext
    - TEEC_OpenSession
    - TEEC_CloseSession
    - TEEC_InvokeCommand
    - TEEC_AllocateSharedMemory
    - TEEC_ReleaseSharedMemory

   Обеспечивая базовые компоненты
   для безопасного взаимодействия и вычислений,
   минимизируя при этом интерфейс,
   предоставляемый Secure OS.

 ## 3.2. Обзор архитектуры системы

  ### 3.2.1. Высокоуровневая архитектура

   #### 3.2.1.1. Архитектурные уровни

   Архитектура системы имеет четкую уровневую структуру,
   где каждый уровень выполняет специфические функции
   и работает на своем уровне привилегий.
   В основе системы лежит аппаратная платформа RISC-V,
   инициализацию которой осуществляет OpenSBI
   (Open Supervisor Binary Interface),
   выполняющий функции SEE.
   OpenSBI предоставляет необходимую
   низкоуровневую аппаратную абстракцию,
   выполняет начальную конфигурацию безопасности
   и управляет процессом передачи
   управления операционным системам.

   Над уровнем встроенного ПО функционирует
   Secure OS, работающая в выделенном
   безопасном мире (Secure World).
   Эта функциональность обеспечивается
   расширением RISC-V World Guard.
   Данное микроядро разработано
   с минимальной TCB.
   Его основные задачи включают
   изолированное выполнение доверенных приложений,
   управление защищенными ресурсами и
   принудительное применение политик безопасности системы.

   Параллельно, в отдельном домене,
   работает ОС нормального мира -
   это полнофункциональная операционная система.
   Она предоставляет среду для выполнения приложений
   общего назначения и взаимодействия с пользователем.

   #### 3.2.1.2. Обзор безопасного и нормального миров

   Система использует статическое распределение
   ресурсов центрального процессора
   для поддержания строгого разделения
   между доменами безопасности. Secure OS
   постоянно находится в памяти
   и исполняется исключительно на
   первом ядре ЦП.
   Это ядро полностью выделено
   для выполнения защищенных операций и доверенных приложений.

   Все остальные ядра ЦП отводятся нормальному миру,
   в котором функционирует операционная система Linux.
   Нормальный мир предоставляет многофункциональную
   среду для вычислений общего назначения,
   однако с точки зрения
   безопасного ира он считается недоверенным.

   Основные роли и обязанности четко разграничены:

  1. Безопасный мир (Secure OS):
   - Предоставляет изолированную среду исполнения
     для доверенных приложений.
   - Управляет защищенными системными ресурсами,
     такими как аппаратное обеспечение
     или защищенные области памяти.
   - Применяет capability-based модель безопасности к TA.
   - Обрабатывает критически важные операции
     и сервисы, запрашиваемые
     нормальным миром через
     строго определенный интерфейс.

  2. Нормальный мир (Linux):
   - Выполняет приложения общего назначения
     и управляет недоверенными системными ресурсами.
   - Взаимодействует с безопасным миром
     исключительно через предопределенный интерфейс
     для запроса к защищенным сервисам.
   - Не имеет прямого доступа к памяти или ресурсам,
     принадлежащим безопасному миру,
     если это явно не разрешено и не опосредовано Secure OS.

   Контроль соблюдения границ обеспечивается
   комбинацией аппаратных и программных механизмов:

  - Аппаратное расширение RISC-V World Guard
    обеспечивает принудительную изоляцию
    на аппаратном уровне,
    предотвращая прямой доступ нормального мира
    к областям памяти или периферийным устройствам,
    назначенным безопасному миру.

  - Обмен данными между мирами (inter-world communication)
    строго контролируется через
    специализированные очереди в разделяемой памяти
    (для запросов и ответов)
    и межпроцессорные прерывания (IPI)
    для сигнализации. Этот контролируемый канал
    гарантирует, что все взаимодействия
    могут быть проверены.

  ### 3.2.2. Ключевые компоненты системы

   #### 3.2.2.1. Ядро, менеджеры ресурсов и сервисы TEE

   Архитектура Secure OS построена на базе микроядра,
   исполняющегося на выделенном для него процессорном ядре.
   Микроядро предоставляет базовые сервисы,
   необходимые для функционирования Доверенной Среды Исполнения.
   К ним относятся безопасное переключение контекста
   между Доверенными Приложениями и внутренними задачами ядра,
   обработка прерываний, специфичных для Защищенного Мира,
   а также реализация механизмов capability-based модели безопасности.
   Микроядро отвечает за управление
   низкоуровневыми аппаратными ресурсами,
   выделенными для Защищенного Мира.

   Поверх микроядра функционируют несколько ключевых менеджеров ресурсов:

  - Менеджер задач (Task Manager): <br>
    Контролирует жизненный цикл TA
    и внутренних задач Защищенной ОС.
    Он отвечает за их создание
    (инициируемое Корневой Задачей (Root Task)
    по запросам из Обычного Мира),
    планирование и завершение.
    Каждое ДП, а также другие управляемые сущности,
    такие как потоки (threads),
    представляются в виде объектов ядра,
    доступ к которым и управление которыми
    осуществляется через дескрипторы
    в соответствии с capability-based моделью.

  - Менеджер памяти: <br>
    Управляет выделением, освобождением
    и защитой памяти в пределах Защищенного Мира.
    Это включает память для самого ядра,
    для отдельных ДП и для буферов,
    используемых при межмировом взаимодействии.
    Он использует базовые аппаратные механизмы,
    такие как PMP совместно с расширением World Guard,
    для обеспечения строгой изоляции памяти
    между различными ДП,
    а также между Защищенным и Обычным Мирами.
    Ресурсы памяти управляются как
    Объекты Виртуальной Памяти (VMO),
    доступ к которым также осуществляется через дескрипторы.

  - Менеджер IPC (Inter-Process Communication Manager): <br>
    Обеспечивает безопасные каналы взаимодействия
    внутри Защищенного Мира,
    например, между различными ДП или между ДП
    и сервисами Защищенной ОС.
    Это достигается с использованием объектов ядра,
    таких как каналы, где доступ и операции
    контролируются через capability,
    представленные дескрипторами.
    Менеджер IPC также поддерживает Root task
    в ее роли по ретрансляции
    сообщений в Обычный Мир и из него.

   Сервисы TEE реализованы поверх ядра
   и менеджеров ресурсов.
   Сервисы предоставляют функциональность
   Защищенной ОС для ДП через определенный API,
   определяемый самими сервисами.
   Сервисы включают управление сессиями ДП,
   обработку вызовов команд из Обычного Мира
   и управление криптографическими операциями.

   #### 3.2.2.2. Разделяемая память и взаимодействие на основе IPI

   Взаимодействие между Обычным Миром (Linux)
   и Защищенной ОС опирается на два основных механизма:
   разделяемую память и Межпроцессорные Прерывания.

   Основу для обмена данными составляют
   две предварительно выделенные страницы физической памяти.
   Одна страница предназначена для очереди запросов
   (Request Queue), позволяя Обычному Миру
   помещать в нее запросы для Защищенной ОС.
   Вторая страница служит очередью ответов
   (Response Queue), через которую
   Защищенная ОС передает результаты
   и уведомления обратно в Обычный Мир.
   Эти очереди реализуются как lock-free
   обеспечения эффективной передачи данных
   и снижения конкуренции за доступ.

   Доступ к этим областям разделяемой памяти
   осуществляется только в соответствии с
   заданной системной политикой безопасности:
   Обычный Мир имеет право записи в очередь запросов,
   из которой читает Защищенная ОС,
   а Защищенная ОС - право записи в очередь ответов,
   из которой читает Обычный Мир.

   Стандартные для RISC-V (IPI) используются
   в качестве механизма сигнализации
   для уведомления другой стороны о наличии сообщений
   в разделяемых очередях.

  - Сигнализация из Обычного Мира в Защищенный: <br>
    Когда Linux (работающий на ядре Обычного Мира)
    помещает новый запрос в разделяемую очередь запросов,
    он затем отправляет IPI на выделенное ядро
    Защищенного Мира (CPU0),
    уведомляя Защищенную ОС
    о доступности нового запроса для обработки.

  - Сигнализация из Защищенного Мира в Обычный: <br>
    После того как Защищенная ОС обработала запрос
    и поместила ответ в разделяемую очередь ответов,
    она не отправляет IPI, обратная передача запроса
    реализована на базе поллинга со стороны Linux драйвера.

   Такое сочетание явно определенных
   областей разделяемой памяти для передачи данных
   и IPI для нотификации о событиях
   формирует надежный и эффективный канал связи.

  ### 3.2.3. Схема распределения памяти и адресация

   #### 3.2.3.1. Физическая и виртуальная адресация

   Secure OS формирует и обслуживает свой собственный,
   отдельный набор таблиц страниц,
   который управляет трансляцией виртуальных адресов
   в физические в пределах Безопасного Мира.
   В процессе инициализации Secure OS настраивает регистр SATP
   (Supervisor Address Translation and Protection)
   для выделенного безопасного процессорного ядра
   таким образом, чтобы он указывал на ее корневую таблицу страниц.
   Это активирует виртуальную адресацию для ядра Secure OS,
   Доверенных Приложений и любых защищенных периферийных устройств,
   назначенных Безопасному Миру.

   Каждое ДП работает в своем собственном
   изолированном виртуальном адресном пространстве,
   управляемом Secure OS. Это гарантирует,
   что ДП не могут напрямую обращаться к памяти друг друга
   или к памяти ядра, если это явно не разрешено через мандаты
   объектов разделяемой памяти.

   Физическая память секционируется ОС
   с использованием расширения World Guard.
   Определенные области физической памяти назначаются
   для эксклюзивного использования Безопасным Миром,
   другие выделяются Нормальному Миру,
   а некоторые, специально ограниченные области,
   определяются как разделяемые.

   Следовательно, отображения памяти в Безопасном Мире
   (устанавливаемые Secure OS) предоставляют доступ
   к защищенным областям физической памяти,
   которые невидимы, для конфигурации MMU из Нормального Мира.
   MMU Нормального Мира функционирует независимо
   на других процессорных ядрах под управлением Linux.

   #### 3.2.3.2. Механизмы изоляции

   Основным аппаратным механизмом обеспечения
   изоляции памяти между Безопасным и Нормальным Мирами
   является расширение RISC-V World Guard.
   World Guard связывает идентификатор мира (world ID)
   с транзакциями памяти, исходящими от процессорных ядер,
   и с обращениями к периферийным устройствам.

   Secure OS в процессе своей загрузки
   и при дальнейшей работе на выделенном безопасном ядре
   конфигурирует аппаратные контроллеры World Guard.
   Эти контроллеры программируются набором правил,
   которые определяют,
   какие области физической памяти и периферийные устройства
   доступны для какого идентификатора мира.

   Например, страницы памяти, выделенные для ядра Secure OS,
   Доверенных Приложений и приватных данных Безопасного Мира,
   конфигурируются таким образом,
   чтобы быть доступными только в том случае,
   если транзакция исходит от процессорного ядра,
   работающего в Безопасном Мире
   (т.е. обладающего идентификатором Безопасного Мира).

   Если операционная система Нормального Мира,
   функционирующая на других ядрах
   с идентификатором Нормального Мира,
   попытается получить доступ
   к странице физической памяти,
   эксклюзивно назначенной Безопасному Миру,
   аппаратные контроллеры World Guard
   обнаружат это нарушение политики.
   Подобные попытки несанкционированного доступа
   приводят к аппаратному исключению,
   которая обрабатывается в соответствии с конфигурацией
   механизма сообщений об ошибках World Guard.
   Это эффективно предотвращает прямое чтение,
   запись или исполнение кода Нормальным Миром
   в пределах защищенных страниц Безопасного Мира.

   #### 3.2.3.3. Очереди в разделяемой памяти

   Взаимодействие между Безопасным и Нормальным Мирами
   осуществляется через зарезервированные
   области физической памяти,
   сконфигурированные как разделяемые буферы.
   В частности, используются две выделенные
   страницы физической памяти,
   выровненные по границе размера страницы:
   одна для запросов от Нормального Мира к Безопасной ОС
   (очередь запросов), а другая — для ответов от Безопасной ОС
   обратно в Нормальный Мир (очередь ответов).

   Безопасная ОС, совместно с
   конфигурациями контроллеров World Guard,
   предоставляет обоим мирам соответствующие права доступа
   к этим специальным разделяемым страницам.

   Данные очереди реализованы в виде lock-free кольцевых буферов,
   что позволяет управлять конкурентным доступом
   без накладных расходов,
   свойственных традиционным механизмам блокировок.
   Использование lock-free алгоритмов минимизирует
   уровень конкуренции за ресурсы и сокращает задержки,
   особенно с учетом того, что Нормальный Мир
   может помещать запросы в очередь из различных
   контекстов исполнения
   (хотя они и обрабатываются последовательно
   одноядерной Безопасной ОС).

   Фиксированный размер и заранее определенное
   расположение этих очередей упрощают
   управление памятью для межмирового обмена данными.

  ### 3.2.4. Процесс исполнения Безопасной ОС

   #### 3.2.4.1. Обзор процесса загрузки Secure OS

   Процесс загрузки начинается с OpenSBI,
   который выполняет начальную настройку платформы.
   OpenSBI идентифицирует и загружает Безопасную ОС,
   передавая ей управление на выделенном первом ядре ЦП (ядре 0).
   Затем Безопасная ОС инициализирует свои ключевые компоненты,
   включая подсистему управления памятью
   и настраивает расширение World Guard для изоляции ядра 0
   в качестве Безопасного Мира.

   Это включает настройку контроллеров WorldGuard
   для защиты памяти Безопасного Мира.
   После своей инициализации Secure OS возвращается обратно OpenSBI.
   После этого OpenSBI приступает к загрузке
   ОС Обычного Мира (Linux) на остальных ядрах ЦП.
   Эти ядра настраиваются OpenSBI

   #### 3.2.4.2. Переходы между мирами

   Переходы исполнения между
   Безопасным и Обычным Мирами строго контролируются.
   Когда Обычному Миру (Linux) необходимо вызвать
   сервис из Безопасной ОС, он подготавливает запрос
   в выделенной очереди запросов в разделяемой памяти,
   а затем, инициирует межпроцессорное прерывание (IPI)
   на ядро 0. Это IPI служит сигналом
   для Безопасной ОС о необходимости проверить очередь запросов.

   Безопасная ОС обрабатывает запрос и помещает ответ
   в очередь ответов в разделяемой памяти.
   Обычный Мир, опрашивает очередь ответов для получения результата.

   Перед обработкой любого запроса из Обычного Мира
   Безопасная ОС выполняет проверки достоверности
   на основе содержимого и источника сообщения.
   Сохранность состояния Безопасного Мира
   во время переходов обеспечивается расширением World Guard,
   которое управляет аппаратным контекстом для текущего мира,
   исполняющегося на ядре.
   Безопасная ОС отвечает за сохранение
   и восстановление контекстов конкретных
   Доверенных Приложений (TA) в Безопасном Мире,
   если под её управлением находится несколько TA или сервисов.

   #### 3.2.4.3. Планирование в Безопасной ОС

   Безопасная ОС функционирует
   на единственном выделенном ядре ЦП (ядре 0)
   и использует однопроцессорную стратегию планирования
   для управления своими внутренними задачами
   и любыми размещаемыми ею Доверенными Приложениями (TA).

   Реализована вытесняющая, round-robin политика
   планирования для обеспечения справедливого доступа
   к ЦП для всех готовых к выполнению сущностей в Безопасном Мире.
   Переключение контекста в Безопасной ОС
   включает сохранение контекста исполнения
   (регистров, указателя стека, счетчика команд)
   текущей TA или сервиса и восстановление контекста
   следующей запланированной сущности.

   Учитывая, что Безопасная ОС и её TA исполняются
   исключительно на ядре 0,
   их деятельность по планированию полностью независима
   и не конфликтует с планировщиком ядра Linux,
   который управляет задачами на других ядрах ЦП,
   работающих в Обычном Мире.
   Архитектура нацелена на то,
   чтобы операции Безопасней ОС были
   относительно кратковременными для
   обеспечения своевременных ответов
   Доверенным Приложениям и запросам из Обычного Мира.

  ### 3.2.5. Обеспечение безопасности и реализация политик

   #### 3.2.5.1. Модель безопасности

   Безопасная ОС применяет многоуровневый подход
   к обеспечению безопасности и реализации политик,
   сочетая механизмы изоляции на аппаратном уровне,
   предоставляемые расширением RISC-V World Guard,
   с программно-определяемой моделью
   гранулярного контроля доступа.
   Такой подход гарантирует защиту как
   Безопасного Мира, так и работающих в нем
   Доверенных Приложений от недоверенного
   Нормального Мира, и, что особенно важно,
   друг от друга, в соответствии с
   принципом наименьших привилегий.

   В Безопасной ОС реализована мандатно-дискреционная модель безопасности,
   где доступ ко всем системным ресурсам
   и сервисам ядра опосредован через дескрипторы,
   или же хендлы (handles).

   Дескриптор выступает в роли неподделываемого токена,
   представляющего определенное полномочие (capability) -
   право на выполнение заданного набора операций
   над связанным объектом ядра
   (например, областями памяти,
   каналами связи, блоками управления задачами).
   Эта модель отличается от традиционного
   контроля доступа,
   фокусируясь на конкретных разрешениях,
   привязанных к экземплярам объектов,
   а не на общих привилегиях пользователя.

   Изначально Доверенные Приложения
   получают набор дескрипторов
   через предопределенный Манифест,
   предоставляемый root таской системы
   при запуске ДП.
   Новые объекты и, соответственно,
   новые дескрипторы с конкретными полномочиями,
   создаются путем вызова методов объекта-фабрики,
   для чего ДП также должно обладать соответствующим дескриптором.

   Операции над этими объектами
   запрашиваются через безопасные системные вызовы
   (secure syscalls),
   которые являются основным интерфейсом между ДП и ядром.
   Предъявляя дескриптор при системном вызове,
   ДП неявно подтверждает свое право
   на выполнение запрошенной операции.
   Этот механизм обеспечивает детальный контроль доступа,
   поскольку каждый дескриптор явно определяет
   допустимые взаимодействия с соответствующим ему объектом.

   Центральное место в этой модели занимает
   контроль соблюдения разрешений на этапе выполнения.
   При вызове системного вызова
   ядро выполняет строгую проверку.
   Сначала оно проверяет аутентичность
   и валидность предъявленного дескриптора,
   убеждаясь, что он соответствует
   активному объекту ядра и может использоваться
   вызывающим ДП в его текущем контексте.
   Затем ядро проверяет, позволяет ли полномочие,
   инкапсулированное в дескрипторе,
   выполнить запрошенную операцию над целевым объектом.
   Если полномочия недостаточны или дескриптор недействителен,
   операция отклоняется, и ДП получает сообщение об ошибке.
   Такая проверка при каждой операции критически важна
   для предотвращения подделки полномочий ДП
   или эскалации привилегий сверх явно предоставленных.
   Поскольку ДП не могут напрямую манипулировать
   содержимым дескрипторов или произвольно создавать
   новые полномочия, они ограничены теми правами,
   которые были им предоставлены через первоначальный Манифест
   или законно получены от объекта-фабрики,
   что надежно обеспечивает соблюдение
   принципа наименьших привилегий.

   #### 3.2.5.2. Интеграция с World Guard

   Программно-определяемая мандатно-дискреционная
   модель безопасности Безопасной ОС
   дополняет аппаратную изоляцию,
   обеспечивая детальный контроль доступа
   внутри Безопасного Мира.

   В то время как World Guard предотвращает
   несанкционированный доступ Нормального Мира
   к ресурсам Безопасного Мира
   и вмешательство в его работу,
   мандатно-дискреционная модель тщательно регулирует
   взаимодействие ДП и компонентов Безопасной ОС
   с объектами и ресурсами, управляемыми ядром.

   Такой многоуровневый подход создает стратегию
   эшелонированной обороны (defense-in-depth):
   World Guard устанавливает надежный межмировой периметр,
   а мандатно-дискреционная система обеспечивает
   строгую компартментализацию и соблюдение политик
   внутри этого периметра.

   Когда аппаратный контроллер (checker) WorldGuard
   обнаруживает попытку несанкционированного
   доступа к памяти (например, код из NW
   пытается прочитать приватную память SW,
   или же наоборот)
   или недействительный переход между мирами
   (например, некорректная инструкция
   пытается незаконно изменить текущее состояние
   мира для данного ядра),
   он генерирует аппаратное исключение (fault).
   Реакция системы на такое событие определяется обработчиками,
   сконфигурированными Безопасной ОС.

   Нарушения, исходящие из Нормального Мира,
   приводят к прерыванию на ядре Нормального Мира,
   вызвавшем нарушение. Специфическая обработка
   (например, сигнализация об ошибке ядру Linux)
   позволяет Нормальному Миру управлять сбоем
   в своем собственном контексте,
   не компрометируя Безопасный Мир.

   Если программный компонент внутри самого
   Безопасного Мира спровоцирует нарушение World Guard
   это также приведет к прерыванию,
   обрабатываемому Безопасной ОС,
   что вызоыет завершение сбойного ДП или сервиса,
   или контролируемую остановку системы,
   если нарушение произошло из ядра Secure OS.

   Таким образом, World Guard выступает как
   механизм принудительного применения
   политики разделения миров,
   с определенными путями обработки сбоев
   при нарушениях этих аппаратно-обеспечиваемых правил.
   Механизмы сообщения об ошибках гарантируют,
   что такие нарушения могут быть зарегистрированы.

  ### 3.2.6 Жизненный цикл доверенных приложений

   #### Создание TA

   Жизненный цикл Доверенного Приложения (ДП)
   в Безопасной ОС инициируется поступлением запроса
   TEEC_OpenSession из Обычного Мира.
   Обработкой данного запроса занимается Root Task,
   ответственная за управление созданием экземпляров ДП.

   Процесс создания ДП включает несколько этапов,
   координируемых Корневой Задачей
   совместно с основными службами Безопасной ОС:

  1. Загрузка образа ДП: <br>
     Безопасная ОС загружает двоичный образ ДП
     (ELF-файла, указанный в предопределенном манифесте
     и размещенный в файловой системе Secure OS)
     в выделенное, изолированное адресное пространство.
     Это включает синтаксический анализ исполняемого формата
     и отображение его сегментов кода,
     данных и BSS в виртуальное адресное пространство ДП.

  2. Выделение памяти: <br>
     Специализированные области памяти выделяются для стека,
     кучи и приватных данных ДП.
     Эта память защищена и изолирована от других ДП
     и самого ядра Безопасной ОС
     с использованием таких механизмов, как PMP и MMU.

  3. Инициализация дескрипторов: <br>
     На основе манифеста ДП Корневая Задача
     предоставляет доверенному приложению
     начальный набор дескрипторов.

  4. Создание процесса/потока: <br>
     В рамках Безопасной ОС для размещения ДП
     создается новая структура процесса (task).
     В этом процессе порождается начальный поток,
     с точкой входа,
     установленной на соответствующую стартовую
     процедуру ДП (TA_CreateEntryPoint).

  5. Начальное состояние: <br>
     После успешного создания и инициализации процесс
     ДП переводится в состояние,
     в котором он уже выполнил свою процедуру
     TA_CreateEntryPoint,
     провел необходимую самоинициализацию
     и готов к приему команд, но изначально неактивен.

   Вызов TEEC_OpenSession возвращает идентификатор сессии
   клиенту в Обычном Мире
   в случае успешного создания ДП
   и установления сессии.
   Этот идентификатор сессии используется
   для последующих взаимодействий с данным экземпляром ДП.

   #### Исполнение TA

   После того как сессия с ДП успешно установлена
   (через TEEC_OpenSession) и его процедура
   TA_CreateEntryPoint завершила свою работу,
   ДП переходит в состояние ожидания
   и уступает управление планировщику Безопасной ОС.
   TA остается неактивной, ожидая конкретных команд из Обычного Мира.

   Дальнейшее взаимодействие осуществляется
   через вызовы TEEC_InvokeCommand,
   поступающие от клиента из Обычного Мира.
   При поступлении такого вызова
   происходит слудующая последовательность действий:

  1. Активация и диспетчеризация: <br>
     Root task получает запрос InvokeCommand.
     Она идентифицирует целевую сессию ДП
     и конкретный идентификатор исполняемой команды
     (ID метода).
     После этого поток ДП активируется
     (ставится в очередь на исполнение).

  2. Передача аргументов: <br>
     Параметры, связанные с InvokeCommand,
     включая идентификатор команды
     и любые буферы ввода/вывода,
     становятся доступными ДП.
     Безопасная ОС гарантирует,
     что ДП получает эти аргументы безопасным
     и определённым образом, через его контекст
     исполнения или заранее подготовленные участки памяти.

  3. Исполнение ДП: <br>
     ДП исполняет свою функцию
     TA_InvokeCommandEntryPoint.
     На основе полученного идентификатора команды
     ДП выполняет запрошенное вычисление.
     Это может включать:
    - Доступ к своим приватным данным и ресурсам.
    - Использование предоставленных ему дескрипторов
      для взаимодействия со службами Безопасной ОС
      (например, криптографическими операциями).
    - Обмен данными с другими ДП или Root task
      через защищённые каналы
      межпроцессного взаимодействия (IPC),
      используя дескрипторы,
      полученные при создании.
    - Запрос на выделение новых областей разделяемой памяти,
      если команда требует обмена большими объемами данных
      с Обычным Миром. Вызов
      API TEEC_AllocateSharedMemory,
      инициированный клиентом Обычного Мира,
      может быть связан с потребностями в памяти,
      выявленными во время выполнения TEEC_InvokeCommand.
      Обмен данными затем осуществляется клиентом
      Обычного Мира и ДП путем записи и чтения
      из этой разделяемой памяти.

   По завершении выполнения команды ДП
   подготавливает любые результаты
   (в выходных буферах или путем
   модификации разделяемой памяти)
   и возвращает код состояния.
   Затем Безопасная ОС передаёт этот статус
   и любые релевантные данные обратно
   клиенту Обычного Мира в качестве ответа
   на TEEC_InvokeCommand.
   После этого ДП может снова уступить управление,
   ожидая дальнейших команд.

   #### Завершение работы TA

   Завершение работы экземпляра Доверенного Приложения
   и освобождение занимаемых им ресурсов инициируются,
   когда клиентское приложение Обычного Мира
   явным образом закрывает сессию с помощью вызова
   TEEC_CloseSession. Этот запрос сигнализирует о том,
   что сервисы ДП для данной конкретной сессии более не требуются.

   Процесс завершения включает следующие ключевые этапы,
   управляемые Безопасной ОС, при содействии
   и с уведомлением Корневой Задачи:

  1. Уведомление о закрытии сессии: <br>
     ДП уведомляется о закрытии своей сессии,
     путем вызова его функции TA_CloseSessionEntryPoint.
     Это позволяет ДП выполнить специфичную
     для сессии очистку,
     например, освободить ресурсы,
     выделенные конкретно для этой сессии.

  2. Уничтожение ДП: <br>
     Если с экземпляром ДП не связано других активных сессий
     (или если ДП предназначено для работы в режиме одной сессии),
     Безопасная ОС приступает к полному прекращению работы
     ДП путем вызова его функции TA_DestroyEntryPoint.
     Эта функция предоставляет ДП последнюю возможность
     выполнить глобальную очистку.

  3. Освобождение ресурсов:
     Освобождаются следующие типы ресурсов:
    - Освобождение объектов: <br>
      Все дескрипторы, принадлежащие ДП,
      аннулируются и освобождаются.
      На соответствующие объекты ядра,
      связанные с этими дескрипторами
      (например, объекты памяти, каналы связи)
      снимаются ссылки. Если ДП было
      последним держателем ссылки,
      сам объект удаляется соответствующим
      менеджером ресурсов Безопасной ОС.
    - Освобождение разделяемой памяти: <br>
      Любые области разделяемой памяти,
      явно выделенные для связи между
      данным экземпляром ДП и Обычным Миром
      (например, через TEEC_AllocateSharedMemory) освобождаются:
      отменяется их отображение (unmap) из адресного пространства
      ДП в Безопасном Мире и помечаются
      для последующего освобождения.
      Драйвер Linux на стороне Обычного Мира,
      как правило, также отвечает
      за отмену отображения этих регионов.
    - Освобождение приватной памяти: <br>
      Приватные области памяти,
      выделенные для кода, данных, стека и кучи ДП,
      возвращаются менеджеру памяти Безопасной ОС.
      Структура задачи/процесса ДП
      и связанные с ней потоки уничтожаются.

   После успешного выполнения этих шагов
   экземпляр ДП прекращает свое существование,
   а его ресурсы становятся доступными
   для повторного выделения.

   Код результата, указывающий на успех
   или неудачу операции TEEC_CloseSession,
   возвращается клиенту Обычного Мира.
   Безопасная ОС гарантирует,
   что процесс завершения работы является упорядоченным
   и не нарушает целостность Безопасного Мира
   или других активных ДП.