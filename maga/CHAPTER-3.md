
# Глава 3: Проектирование и реализация доверенной операционной системы

 ## 3.1. Соображения по выбору интерфейса

  ### 3.1.1. Базовое API ДСИ: Интерфейс взаимодействия между мирами

   #### 3.1.1.1. Введение в TEE API

   Базовое API TEE (Trusted Execution Environment Internal Core API)
   определяет функции, которые клиенты нормального мира
   используют для взаимодействия с доверенными приложениями,
   работающими в Secure OS.
   Этот интерфейс должен предоставлять
   механизмы для установки соединения,
   обмена данными, вызова защищённых функций
   и управления жизненным циклом безопасных сессий.

   Рассмотрим варианты, на которые можно обратить
   внимание при выборе интерфейса
   для доверенной операционной системы.

   #### 3.1.1.2. OP-TEE для RISC-V

   OP-TEE (Open Portable TEE) -
   это известная среда доверенного исполнения
   с открытым исходным кодом,
   изначально разработанная для технологии Arm TrustZone.
   OP-TEE реализует значительную часть спецификаций
   GlobalPlatform TEE, предоставляя богатый набор функций,
   включая внутренний API ядра TEE
   (TEE Internal Core API) для разработки TA
   и полнофункциональный клиентский API TEE.

   Хотя OP-TEE представляет собой зрелое
   и широко распространённое решение TEE,
   его архитектура сопряжена с определёнными особенностями.
   OP-TEE сама по себе является
   небольшой безопасной операционной системой,
   обычно работающей параллельно
   с Rich OS. Для данного проекта, прямое использование
   API OP-TEE потребовало бы либо значительных усилий
   по портированию и адаптации,
   либо диктовало бы архитектурные решения,
   менее соответствующие целям проекта по созданию минимальной,
   глубоко проработанной доверенной кодовой базы (TCB),
   адаптированной под World Guard.

   #### 3.1.1.3. Разработка собственного минимального интерфейса на базе GlobalPlatform TEE

   Альтернативным подходом рассматривалась
   разработка собственного,
   минимально необходимого интерфейса TEE,
   основанного на спецификациях
   GlobalPlatform TEE Internal Core API.
   Этот путь предполагает реализацию
   только ключевых функций API,
   необходимых для базового взаимодействия с TA:
   управление контекстами, сессиями, разделяемой памятью и вызовом команд.

   Разработка собственного минимального
   интерфейса имела несколько преимуществ:

  - Снижение сложности: <br>
    Меньший набор функций API
    упрощает реализацию Secure OS,
    что потенциально ведёт к уменьшению
    доверенной кодовой базы (TCB)
    и поверхности атак.

  - Адаптация под World Guard: <br>
    Интерфейс мог бы быть специально спроектирован
    для эффективного использования двухмировой модели
    расширения World Guard и его примитивов
    межмирового взаимодействия.
    Например, парадигма обмена данными
    через разделяемую память,
    предусмотренная проектом,
    может быть напрямую отражена в дизайне API.

  - Согласованность с архитектурой Безопасной ОС: <br>
    Интерфейс мог бы быть оптимально интегрирован
    с микроядерной архитектурой Secure OS
    и её handle-based моделью безопасности.

  - Контролируемый объём работ: <br>
    такой подход позволяет сфокусировать усилия
    на реализации ключевых функций TEE
    и их взаимодействии с World Guard.

   Основной проблемой этого подхода является
   обеспечение соответствия стандартам,
   даже для подмножества функций,
   и предоставление достаточной функциональности
   для создания значимых TA.

   #### 3.1.1.4. Экспериментальные и исследовательские прототипы

   В академическом и исследовательском сообществе
   существуют различные архитектуры TEE
   и механизмы межмирового взаимодействия,
   часто фокусируясь на новых аппаратных возможностях
   или специфических свойствах безопасности.
   Некоторые прототипы исследуют собственные механизмы RPC,
   отличающиеся модели разделения памяти
   или совершенно новые парадигмы API,
   отличные от GlobalPlatform.

   Хотя такие исследовательские прототипы
   предлагают ценные идеи для потенциальных улучшений TEE
   и специализированных решений безопасности,
   им часто не хватает стандартизации
   и широкой поддержки со стороны экосистемы,
   что критично для разработки переносимых TA.

   Внедрение полностью экспериментального API
   отклонилось бы от признанных в индустрии стандартов,
   повысило бы порог вхождения для потенциальных разработчиков
   и ограничило бы совместимость.

   #### 3.1.1.5. Обоснование выбора подмножества API на базе GlobalPlatform

   После оценки альтернатив было принято решение
   использовать тщательно подобранное подмножество
   GlobalPlatform TEE Internal Core API
   для межмирового взаимодействия.
   Этот подход призван сбалансировать стремление
   к стандартизации со специфическими требованиями
   и ограничениями проекта.

   Выбор стоится на следущих причинах:

  - Стандартизация и привычность: <br>
    Спецификации GlobalPlatform TEE Internal Core API
    предоставляют хорошо определённый,
    признанный в индустрии стандарт
    для взаимодействия между клиентом TEE и TA.
    Использование подмножества этого стандарта
    позволяет опереться на существующую базу знаний,
    облегчая разработчикам TA,
    знакомым с концепциями TEE,
    понимание и использование системы.

  - Ключевая функциональность: <br>
    GP TEE API определяет такие основополагающие концепции,
    как контексты, сессии, разделяемая память и вызов команд,
    которые являются фундаментальными
    для большинства взаимодействий с TEE.
    Реализация подмножества, содержащего эти ключевые элементы,
    обеспечивает достаточную функциональность
    для широкого круга Доверенных Приложений.

  - Уменьшение трудоёмкости реализации и ДКБ: <br>
    Выбирая только необходимые вызовы API,
    значительно снижается сложность реализации
    в Secure OS по сравнению с полной имплементацией GP.
    Это способствует уменьшению TCB,
    что критично для безопасности.

  - Возможность будущего расширения: <br>
    Начиная с минимального подмножества,
    фреймворк GP предлагает чёткий путь
    для потенциальных будущих расширений,
    если потребуется больше функций.
    Модульная природа спецификаций GP
    позволяет добавлять функциональность постепенно.

   Выбранное подмножество включает функции:
    - TEEC_InitializeContext
    - TEEC_FinalizeContext
    - TEEC_OpenSession
    - TEEC_CloseSession
    - TEEC_InvokeCommand
    - TEEC_AllocateSharedMemory
    - TEEC_ReleaseSharedMemory

   Обеспечивая базовые компоненты
   для безопасного взаимодействия и вычислений,
   минимизируя при этом интерфейс,
   предоставляемый Secure OS.

  ### 3.1.2. Архитектурные уровни

   Архитектура системы имеет четкую уровневую структуру,
   где каждый уровень выполняет специфические функции
   и работает на своем уровне привилегий.
   В основе системы лежит аппаратная платформа RISC-V,
   инициализацию которой осуществляет OpenSBI
   (Open Supervisor Binary Interface),
   выполняющий функции SEE.
   OpenSBI предоставляет необходимую
   низкоуровневую аппаратную абстракцию,
   выполняет начальную конфигурацию безопасности
   и управляет процессом передачи
   управления операционным системам.

   Над уровнем встроенного ПО функционирует
   Secure OS, работающая в выделенном
   безопасном мире (Secure World).
   Эта функциональность обеспечивается
   расширением RISC-V World Guard.
   Данное микроядро разработано
   с минимальной TCB.
   Его основные задачи включают
   изолированное выполнение доверенных приложений,
   управление защищенными ресурсами и
   принудительное применение политик безопасности системы.

   Параллельно, в отдельном домене,
   работает ОС нормального мира -
   это полнофункциональная операционная система.
   Она предоставляет среду для выполнения приложений
   общего назначения и взаимодействия с пользователем.

   #### 3.1.2.1. Обзор безопасного и нормального миров

   Система использует статическое распределение
   ресурсов центрального процессора
   для поддержания строгого разделения
   между доменами безопасности. Secure OS
   постоянно находится в памяти
   и исполняется исключительно на
   первом ядре ЦП.
   Это ядро полностью выделено
   для выполнения защищенных операций и доверенных приложений.

   Все остальные ядра ЦП отводятся нормальному миру,
   в котором функционирует операционная система Linux.
   Нормальный мир предоставляет многофункциональную
   среду для вычислений общего назначения,
   однако с точки зрения
   безопасного ира он считается недоверенным.

   Основные роли и обязанности четко разграничены:

  1. Безопасный мир (Secure OS):
   - Предоставляет изолированную среду исполнения
     для доверенных приложений.
   - Управляет защищенными системными ресурсами,
     такими как аппаратное обеспечение
     или защищенные области памяти.
   - Применяет capability-based модель безопасности к TA.
   - Обрабатывает критически важные операции
     и сервисы, запрашиваемые
     нормальным миром через
     строго определенный интерфейс.

  2. Нормальный мир (Linux):
   - Выполняет приложения общего назначения
     и управляет недоверенными системными ресурсами.
   - Взаимодействует с безопасным миром
     исключительно через предопределенный интерфейс
     для запроса к защищенным сервисам.
   - Не имеет прямого доступа к памяти или ресурсам,
     принадлежащим безопасному миру,
     если это явно не разрешено и не опосредовано Secure OS.

   Контроль соблюдения границ обеспечивается
   комбинацией аппаратных и программных механизмов:

  - Аппаратное расширение RISC-V World Guard
    обеспечивает принудительную изоляцию
    на аппаратном уровне,
    предотвращая прямой доступ нормального мира
    к областям памяти или периферийным устройствам,
    назначенным безопасному миру.

  - Обмен данными между мирами (inter-world communication)
    строго контролируется через
    специализированные очереди в разделяемой памяти
    (для запросов и ответов)
    и межпроцессорные прерывания (IPI)
    для сигнализации. Этот контролируемый канал
    гарантирует, что все взаимодействия
    могут быть проверены.