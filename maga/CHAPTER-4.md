
# Глава 4: Результат и анализ безопасности

 ## 4.1. Используемый стек программного обеспечения

  ### 4.1.1. Инструментарий

   #### 4.1.1.1. Среда разработки

   Для кросс-компиляции компонентов
   Безопасного мира используется инструментарий RISC-V GNU,
   в частности, GCC версии 11.1.0 и Binutils 2.38.

   Как сама Безопасная ОС, так и Доверенные приложения
   компилируются с флагами для архитектуры RISC-V.

   В качестве основной системы для разработки
   рекомендуется использовать ОС на базе Linux
   (например, Ubuntu 20.04).
   Система сборки требует CMake версии 3.14 или выше.
   Отладка осуществляется с помощью GDB,
   который подключается к GDB серверу QEMU,
   что позволяет инспектировать состояние ядра
   Безопасной ОС на самом низком уровне.

  ### 4.1.2. Среда эмуляции

   #### 4.1.2.1. QEMU с поддержкой WorldGuard

   Для работы используется надежная среда
   эмуляции на базе модифицированной версии QEMU.
   Такая среда предоставляет виртуальную платформу,
   симулирующую архитектуру RISC-V с расширением WorldGuard,
   что обеспечивает воспроизводимое тестирование
   без необходимости в физическом оборудовании.

   Эмуляция основана на форке QEMU версии v9.1.50 riscv64-softmmu,
   в который были внесены патчи для реализации
   ISA-расширения WorldGuard.
   Эти модификации включают реализацию специфичных
   для WorldGuard регистров управления и состояния (CSR),
   а также логики контроля доступа к памяти
   на основе идентификатора мира (world ID).

   #### 4.1.2.2. Конфигурация QEMU

   Система эмулируется с использованием машинной модели
   virt с 4 ядрами: харядро 0 эксклюзивно выделено для Безопасной ОС,
   а остальные - для Linux.
   Файл дерева устройств (DTB) определяет
   физическую карту памяти, используемых устройств.

   QEMU запускается со следующими флагами:

   ```bash
   qemu-system-riscv64 -M virt,wg=on -m 4G -nographic -smp 4 -bios sbi.bin -kernel LinuxImage -drive file=debian10.img,format=raw -netdev user,id=net0,hostfwd=tcp::2222-:22 -device virtio-net-device,netdev=net0 -append "root=/dev/vda rw earlycon=sbi,keep net.ifnames=0 kaslr=off"
   ```

  ### 4.1.3. Linux

   #### 4.1.3.1. Linux с поддержкой WorldGuard

   Стандартное ядро Linux выступает в роли
   операционной системы Обычного мира.
   В этой среде работают пользовательские приложения
   и драйвер ядра, отвечающий за инициацию
   взаимодействия с Безопасной ОС и её Доверенными приложениями.

   В проекте используется ядро Linux, основанное на LTS-версии 6.12.0.
   Оно включает набор внешних патчей,
   которые в содержат драйвер символьного устройства,
   реализующий клиентскую часть протокола TEE.
   Этот драйвер предоставляет стандартный интерфейс
   на основе ioctl для взаимодействия
   пользовательских приложений с Безопасным миром.

   #### 4.1.3.2. Конфигурация Linux

   Ядро собирается с минимальной конфигурацией на основе defconfig
   для архитектуры RISC-V.
   Ключевая включенная опция - это CONFIG_WG_TEE.
   Конфигурация нацелена на создание компактного образа ядра
   с минимальным набором драйверов, необходимых для запуска в среде QEMU.

   #### 4.1.3.3. Образ Linux

   Загрузочный компонент Linux состоит из образа
   на базе дистрибутива debian 10.
   Файловая система создается примонтированном в QEMU диске.

  ### 4.1.4. Система сборки

   #### 4.1.4.1. Конфигурация CMake

   Для компиляции всех программных компонентов проекта используется
   централизованная и модульная система сборки на основе CMake
   версии не менее 3.14.

   #### 4.1.4.2. Дизайн системы сборки

   Система сборки организована с корневым файлом CMakeLists.txt,
   который подключает подкаталоги с ядром Безопасной ОС,
   стандартными библиотеками и Доверенными приложениями.

   #### 4.1.4.3. Процесс сборки Доверенного приложения (ДП)

   Каждое Доверенное приложение собирается как
   отдельный позиционно-независимый ELF-файл.
   Процесс сборки ДП включает компиляцию его исходного кода
   с использованием стандартной библиотеки Безопасной ОС
   и обработку файла-манифеста.
   Манифест, определяющий UUID приложения и его начальные права доступа,
   встраивается в специальную секцию итогового ELF-файла,
   откуда он считывается Безопасной ОС при инициализации.

  ### 4.1.5. Интеграция с CI

   #### 4.1.5.1. Настройка непрерывной интеграции

   Для обеспечения качества и стабильности кода
   используется конвейер непрерывной интеграции (CI),
   который автоматизирует процессы сборки и тестирования.

   Автоматизация подтверждает,
   что вносимые изменения не приводят к регрессиям,
   и гарантирует работоспособность всего программного стека.

   Проект использует GitHub Actions в качестве платформы для CI.
   Рабочий процесс настроен так,
   что он запускается при каждой отправке изменений (push)
   в основные ветки.
   Он последовательно выполняет серию задач:
   сначала собирается кросс-компилятор,
   затем модифицированный QEMU,
   OpenSBI, Безопасная ОС со своими ДП и,
   наконец, ядро Linux.

   #### 4.1.5.2. Скрипты автоматизированного тестирования

   На заключительном этапе конвейера CI выполняется
   автоматизированный тест, реализованный на Python.
   Этот скрипт запускает полностью собранную систему
   в QEMU с поддержкой WorldGuard,
   в Безопасной ОС при этом запускаются тестовые сценарии.
   Таким образом проверяется, что и Безопасная ОС,
   и Linux успешно загрузились,
   а также подтверждается корректная инициализация драйвера связи
   и выполнение тестовой команды в образцовом Доверенном приложении.